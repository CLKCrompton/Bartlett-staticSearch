<?xml version="1.0" encoding="UTF-8"?>
<project basedir="." name="BuildStaticSearch" default="all">
  
  <property name="saxon" value="${basedir}/lib/saxon9he.jar"/>
    
  <property name="config" value="config.xml"/>
  
  <property name="configFile" value="${basedir}/${config}"/>
  
    <property name="keatsBuildUrl" value="https://jenkins.hcmc.uvic.ca/job/Keats/lastSuccessfulBuild/artifact/site/*zip*/site.zip"/>
    
    
  <property name="verbose" value="true"/>
    
    <target name="clean">
        <delete dir="temp"/>
        <delete file="xsl/config.xsl"/>
    </target>
    
  <!--First thing, create the config file-->
   <target name="config">
       <java classpath="${saxon}" classname="net.sf.saxon.Transform" failonerror="true" >
           <arg value="-xsl:xsl/create_config_xsl.xsl"/>
           <arg value="-s:xsl/create_config_xsl.xsl"/>
           <arg value="configFile=${configFile}"/>
           <arg value="--suppressXsltNamespaceCheck:on"/>
       </java>
   </target>
    
    <target name="tokenize">
        <java classpath="${saxon}" classname="net.sf.saxon.Transform" failonerror="true" >
            <arg value="-xsl:xsl/tokenize.xsl"/>
            <arg value="-s:xsl/tokenize.xsl"/>
            <arg value="--suppressXsltNamespaceCheck:on"/>
        </java>
    </target>
    
  <!--Then tokenize-->
    
    
    
  <!--Then create JSON-->
    
    <target name="json">
        <java classpath="${saxon}" classname="net.sf.saxon.Transform" failonerror="true" >
            <arg value="-xsl:xsl/json.xsl"/>
            <arg value="-s:xsl/json.xsl"/>
            <arg value="--suppressXsltNamespaceCheck:on"/>
        </java>
    </target>
    
    <target name="report">
        <java classpath="${saxon}" classname="net.sf.saxon.Transform" failonerror="true" >

            <arg value="-xsl:xsl/create_reports.xsl"/>
            <arg value="-s:xsl/create_reports.xsl"/>
            <arg value="--suppressXsltNamespaceCheck:on"/>
        </java>
        <open file="${basedir}/staticSearch_report.html"/>
    </target>
    
    <target name="makeTestCopy">
        <copy todir="js">
            <fileset dir="site">
                <include name="js/**"/>
            </fileset>
        </copy>
    </target>
    
    <target name="getKeats">
        <description>
            TARGET getKeats
            This target pulls the latest build of the site Mapping Keats's Progress from the 
            HCMC Jenkins build server, so that it can be used as a testbed for staticSearch.
            The site is large and complex enough to serve as a useful comprehensive test.
        </description>
        <echo message="Downloading build of Keats site from ${keatsBuildUrl} ..."/>
        <mkdir dir="${basedir}/keatsTemp"/>
        <get src="${keatsBuildUrl}" verbose="on" usetimestamp="true" dest="${basedir}/keatsTemp/"/>
        <echo message="Unzipping Keats site into ${basedir}/keatsTemp/ ..."/>
        <unzip src="${basedir}/keatsTemp/site.zip" dest="${basedir}/keatsTemp/"/>
        <delete file="${basedir}/keatsTemp/site.zip"/>
        <delete dir="${basedir}/keats"/>
        <mkdir dir="${basedir}/keats"/>
        <echo message="Copying site content into ${basedir}/keats/ ..."/>
        <copy todir="${basedir}/keats/">
            <fileset dir="${basedir}/keatsTemp/site" includes="**/*"/>
        </copy>
        <echo message="Cleaning up ..."/>
        <delete dir="${basedir}/keatsTemp/"/>
    </target>
    
    <!--Javascript OPEN task-->
    
    <!--  This is taken with thanks from:
      http://stackoverflow.com/questions/4696176/using-ant-how-do-i-open-a-file-in-a-browser -->
    <scriptdef name="open" language="javascript">
        <attribute name="file" />
        <![CDATA[
        var location = "file://"+attributes.get("file").toString().replaceAll("\\\\","/");
        location = location.toString().replaceAll(" ","%20");
        location = java.net.URLEncoder.encode(location, "UTF-8");
        location = location.toString().replaceAll("%3A",":");
        location = location.toString().replaceAll("%2F","/");
        location = location.toString().replaceAll("%25","%");
        var uriLocation = java.net.URI.create(location);
        var desktop = java.awt.Desktop.getDesktop();
        desktop.browse(uriLocation);
    ]]>
    </scriptdef>
    
    <target name="all" depends="clean, config, tokenize, json, makeTestCopy, report"/>
</project>